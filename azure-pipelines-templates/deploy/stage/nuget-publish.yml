# this template expects packages to be built with azure-pipelines-templates/build/step/nuget-build.yml
stages:
- stage: NuGetPublish
  condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Manual'), eq(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/main')))
  displayName: Publish NuGet Package
  pool:
    name: SLD Build Pool
  jobs:
  - job: CleanArtifacts
    displayName: Clean artifacts directory
    workspace:
      clean: all

  # Manual approval gate: the publish job will only run if someone explicitly approves.
  # If rejected (or it times out), the stage fails and no NuGet push happens.
  - job: AwaitPublishApproval
    displayName: 'Manual approval: publish NuGet package'
    dependsOn: CleanArtifacts
    pool: server
    timeoutInMinutes: 1440
    steps:
    - task: ManualValidation@0
      displayName: 'Approve or reject NuGet publish'
      inputs:
        instructions: |
          Approve to publish the NuGet package(s) built by this run.

          - Approve = proceeds with NuGet push
          - Reject = stops the publish stage
        onTimeout: 'reject'

  - deployment: NuGetPush
    dependsOn: AwaitPublishApproval
    environment: Nuget
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: NuGetPackages
          - task: NuGetCommand@2
            displayName: NuGet push
            inputs:
              command: push
              packagesToPush: '$(Pipeline.Workspace)/NuGetPackages/*.nupkg;!$(Pipeline.Workspace)/NuGetPackages/*.symbols.nupkg'
              allowPackageConflicts: true
              nuGetFeedType: external
              publishFeedCredentials: 'Paymentsv2-Nuget'
